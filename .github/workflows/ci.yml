# =============================================================
# ci.yml â€” GitHub Actions CI/CD Pipeline
# Financial Analysis Multi-Agent System
#
# Pipeline flow (jobs run in dependency order):
#   lint â”€â”€â”¬â”€â”€â–º test
#          â””â”€â”€â–º security
#               both â”€â”€â–º build â”€â”€â–º deploy-staging (master only)
# =============================================================

name: CI/CD â€” Financial Analysis Multi-Agent

# â”€â”€ Triggers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Run the pipeline when code is pushed to these branches,
# OR when a pull-request targets master / main.
on:
    push:
        branches: [master, main, develop]
    pull_request:
        branches: [master, main]

# â”€â”€ Shared environment variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Defined once here so every job gets the same Python version
# without repeating the string.
env:
    PYTHON_VERSION: "3.11"

jobs:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Job 1 Â· LINT
    # Purpose: Catch syntax errors and PEP 8 style violations
    #          before running any tests. Fails fast so developers
    #          get feedback in < 1 minute.
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    lint:
        name: ðŸ” Lint & Static Analysis
        runs-on: ubuntu-latest # Use the latest Ubuntu GitHub-hosted runner

        steps:
            # 1-a. Check out the repository so subsequent steps have access to source code.
            - name: Checkout code
              uses: actions/checkout@v4

            # 1-b. Install the requested Python version.
            #      `cache: pip` speeds up runs by reusing previously downloaded wheels.
            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            # 1-c. Install only the tools needed for linting (keeps this job lightweight).
            - name: Install lint dependencies
              run: |
                  pip install --upgrade pip
                  pip install flake8 pylint

            # 1-d. STRICT pass: only flag real errors (undefined names, syntax issues).
            #      The pipeline FAILS if any of these are found.
            # 1-d. STRICT pass: E9=runtime errors, F63/F7=serious issues, F82=undefined names.
            #      --show-source prints the offending line; --statistics shows a count per error code.
            #      The pipeline FAILS if any of these are found.
            - name: Run flake8 (PEP8 / syntax errors)
              run: |
                  flake8 . \
                    --count \
                    --select=E9,F63,F7,F82 \
                    --show-source \
                    --statistics \
                    --exclude=multiagent_env,__pycache__,.git

            # 1-e. ADVISORY pass: report style warnings but don't fail the build.
            #      --exit-zero always exits 0 (treats warnings as informational).
            #      --max-line-length=120 relaxes the default 79-char limit.
            #      continue-on-error: true keeps the job green even if warnings exist.
            - name: Run flake8 (style warnings)
              run: |
                  flake8 . \
                    --count \
                    --exit-zero \
                    --max-line-length=120 \
                    --statistics \
                    --exclude=multiagent_env,__pycache__,.git
              continue-on-error: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Job 2 Â· UNIT TESTS
    # Purpose: Run the test suite against multiple Python versions
    #          to verify nothing is broken after each commit.
    # Depends on: lint (must pass first)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    test:
        name: ðŸ§ª Unit Tests
        runs-on: ubuntu-latest
        needs: lint # Only runs if the lint job succeeded

        # Matrix strategy: GitHub spins up one parallel job per Python version,
        # so we test 3.10, 3.11, and 3.12 simultaneously.
        strategy:
            matrix:
                python-version: ["3.10", "3.11", "3.12"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Use the matrix variable here (not the global env.PYTHON_VERSION).
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: pip

            # Install the full application dependencies defined in requirements.txt.
            - name: Install dependencies
              run: |
                  pip install --upgrade pip
                  pip install -r requirements.txt

            # Run pytest with a short traceback format.
            # The DEEPSEEK_API_KEY secret is injected from GitHub repository secrets.
            # A dummy fallback is provided so CI doesn't hard-fail if the secret is not set.
            # Run pytest with a short traceback format.
            # --tb=short: enough detail without overwhelming output.
            # --timeout=60: kill any test that hangs for more than 60 seconds.
            # -v: verbose â€” shows each test name and pass/fail status.
            # MCP_SERVER_HOST=localhost: points MCP clients at localhost (servers are mocked).
            - name: Run pytest
              env:
                  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY || 'sk-dummy-key-for-ci' }}
                  MCP_SERVER_HOST: localhost
              run: |
                  pytest \
                    --tb=short \
                    --timeout=60 \
                    -v

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Job 3 Â· SECURITY SCAN
    # Purpose: Detect common security issues in Python code
    #          (hardcoded passwords, unsafe calls, etc.) using Bandit.
    # Depends on: lint
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    security:
        name: ðŸ”’ Security Scan
        runs-on: ubuntu-latest
        needs: lint # Run in parallel with tests, after lint passes

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            - name: Install Bandit
              run: pip install bandit

            # Scan all Python source files recursively.
            # -x  : exclude directories that don't contain application code
            # --severity-level medium : only report MEDIUM and HIGH severity issues
            # -f json : machine-readable output stored as a build artifact
            # -x excludes dirs with no application code.
            # --severity-level medium: only report MEDIUM and HIGH severity issues.
            # -f json: machine-readable output uploaded as a build artifact.
            # || true: don't fail the pipeline on findings â€” review the artifact instead.
            - name: Run Bandit security scan
              run: |
                  bandit -r . \
                    -x ./multiagent_env,./mock_data,./data \
                    --severity-level medium \
                    -f json -o bandit-report.json \
                    || true

            # Upload the JSON report so it can be downloaded from the Actions run page.
            # `if: always()` ensures the artifact is uploaded even if Bandit found issues.
            - name: Upload Bandit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: bandit-security-report
                  path: bandit-report.json

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Job 4 Â· BUILD & PACKAGE CHECK
    # Purpose: Verify the full dependency stack installs cleanly
    #          and that all Python files are syntactically valid.
    # Depends on: test AND security (both must pass)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    build:
        name: ðŸ“¦ Build & Package Check
        runs-on: ubuntu-latest
        needs: [test, security] # Gate on both upstream jobs

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: pip

            - name: Install all dependencies
              run: |
                  pip install --upgrade pip
                  pip install -r requirements.txt

            # Walk every .py file (skipping venv and cache) and parse it with the
            # Python AST module. Exits 1 if any file has a syntax error.
            - name: Verify imports and module structure
              env:
                  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY || 'sk-dummy-key-for-ci' }}
              run: |
                  python -c "
                  import ast, sys, pathlib

                  errors = []
                  for f in pathlib.Path('.').rglob('*.py'):
                    if any(skip in str(f) for skip in ['multiagent_env', '__pycache__']):
                      continue
                    try:
                      ast.parse(f.read_text(encoding='utf-8'))
                    except SyntaxError as e:
                      errors.append(f'{f}: {e}')

                  if errors:
                    print('Syntax errors found:', *errors, sep='\n  ')
                    sys.exit(1)
                  else:
                    print('All Python files parse without syntax errors âœ…')
                  "

            # Preserve an exact snapshot of the dependencies used in this successful build.
            # Useful for auditing or rolling back to a known-good state.
            - name: Upload requirements snapshot
              uses: actions/upload-artifact@v4
              with:
                  name: requirements-snapshot
                  path: requirements.txt

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Job 5 Â· DEPLOY TO STAGING
    # Purpose: Deploy the application after all checks pass.
    #          Only runs on direct pushes to master (not on PRs).
    # Depends on: build
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    deploy-staging:
        name: ðŸš€ Deploy â€” Staging
        runs-on: ubuntu-latest
        needs: build # Only deploy if the build job succeeded

        # Condition: skip this job for pull-requests â€” only deploy real merges to master.
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'

        # Link this job to the GitHub "staging" environment.
        # Environments can require manual approval via protection rules in repo settings.
        environment:
            name: staging
            url: https://github.com/${{ github.repository }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Print a clear deployment summary to the Actions log for traceability.
            - name: Deployment summary
              run: |
                  echo "======================================"
                  echo "  Financial Analysis â€” Staging Deploy"
                  echo "======================================"
                  echo "Commit  : ${{ github.sha }}"
                  echo "Author  : ${{ github.actor }}"
                  echo "Branch  : ${{ github.ref_name }}"
                  echo "Run ID  : ${{ github.run_id }}"
                  echo "======================================"
                  echo "âœ… Staging deployment step complete."
                  echo ""
                  echo "ðŸ‘‰ Replace this step with your actual deploy commands, for example:"
                  echo "   â€¢ docker build -t myapp . && docker push myregistry/myapp"
                  echo "   â€¢ ssh user@server 'cd /app && git pull && systemctl restart myapp'"
                  echo "   â€¢ kubectl rollout restart deployment/financial-analysis"
