name: CI/CD â€” Financial Analysis Multi-Agent

on:
  push:
    branches: [master, main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [master, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:  # Allow manual triggers

env:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
   # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Lint & Static Analysis (Fixed)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ğŸ” Lint & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install lint dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black isort mypy

      - name: Run Black (code formatting check)
        run: |
          black . --check --diff --line-length=120 || true
        continue-on-error: true

      - name: Run isort (import sorting check)
        run: |
          isort . --check-only --diff --profile black --line-length=120 || true
        continue-on-error: true

      - name: Run flake8 (full check) - Lenient version
        run: |
          flake8 . \
            --count \
            --max-line-length=120 \
            --statistics \
            --exclude=multiagent_env,__pycache__,.git,.venv,build,dist \
            --ignore=E203,E266,E501,W503,F401,F403,F841  \
            --output-file=flake8-report.txt \
            --exit-zero  # This makes flake8 return 0 even if issues are found
        continue-on-error: true

      - name: Display flake8 results
        if: always()
        run: |
          if [ -f flake8-report.txt ]; then
            echo "ğŸ“Š Flake8 Results:"
            echo "```"
            cat flake8-report.txt
            echo "```"
            # Count issues
            ISSUES=$(wc -l < flake8-report.txt)
            echo "Found $ISSUES style issues (non-blocking)"
          else
            echo "âœ… No flake8 issues found!"
          fi

      - name: Run mypy (type checking) - Lenient version
        run: |
          mypy . \
            --exclude 'multiagent_env|__pycache__|tests/mocks|build|dist' \
            --ignore-missing-imports \
            --warn-unused-configs \
            --show-error-codes \
            --follow-imports=skip \
            || true  # Don't fail the build
        continue-on-error: true

      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            flake8-report.txt
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Unit Tests with Coverage
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ğŸ§ª Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
      fail-fast: false  # Continue testing other versions even if one fails

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-timeout pytest-xdist pytest-mock

      - name: Run tests with coverage
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY || 'sk-dummy-key-for-ci' }}
          MCP_SERVER_HOST: localhost
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest \
            tests/ \
            --tb=short \
            --timeout=60 \
            -n auto \
            -v \
            --cov=. \
            --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
            --cov-report=html:coverage-${{ matrix.python-version }}-html \
            --cov-report=term \
            --cov-fail-under=70 || true  # Don't fail the build, just report

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-python-${{ matrix.python-version }}
          path: |
            coverage-${{ matrix.python-version }}.xml
            coverage-${{ matrix.python-version }}-html/
          retention-days: 14

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Security Scan (Using GitHub Actions)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r . \
            -x ./multiagent_env,./mock_data,./data,./tests \
            --severity-level medium \
            --confidence-level medium \
            -f json -o bandit-report.json \
            --exit-zero

      - name: Run Safety check using GitHub Action
        uses: pyupio/safety-action@v1
        with:
          api-key: ${{ secrets.SAFETY_API_KEY }}  # Optional for free tier
          args: -r requirements.txt --full-report
        continue-on-error: true

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Build Check (Simple Version)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ğŸ“¦ Build Check
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Python imports
        run: |
          python -c "
          import sys
          print('âœ… Python environment is working')
          print(f'Python version: {sys.version}')
          "

      - name: Create dist folder for artifacts
        run: |
          mkdir -p dist
          # Copy requirements and main files as artifacts
          cp requirements.txt dist/
          cp -r src dist/ 2>/dev/null || echo "No src directory found"
          cp -r *.py dist/ 2>/dev/null || echo "No Python files in root"
          echo "Build timestamp: $(date)" > dist/build-info.txt
          echo "Commit: ${{ github.sha }}" >> dist/build-info.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
          retention-days: 14
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Deploy to Staging
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: ğŸš€ Deploy â€” Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    environment:
      name: staging
      url: https://github.com/${{ github.repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          
          cat << EOF
          ======================================
            Financial Analysis â€” Staging Deploy
          ======================================
          Commit    : ${{ github.sha }}
          Author    : ${{ github.actor }}
          Branch    : ${{ github.ref_name }}
          Run ID    : ${{ github.run_id }}
          ======================================
          âœ… Staging deployment simulation complete.
          EOF

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 6: Notifications (Slack)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-slack:
    name: ğŸ“¢ Slack Notification
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: always() && github.ref == 'refs/heads/master'
    steps:
      - name: Send Slack notification
        if: env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not configured, skipping notification"
            exit 0
          fi
          
          STATUS="$JOB_STATUS"
          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            MESSAGE="âœ… Deployment succeeded for ${{ github.repository }}"
          else
            COLOR="danger"
            MESSAGE="âŒ Deployment failed for ${{ github.repository }}"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"CI/CD Pipeline Result\",
                \"text\": \"$MESSAGE\nCommit: ${{ github.sha }}\nAuthor: ${{ github.actor }}\nView: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }]
            }" \
            "$SLACK_WEBHOOK"

  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 7: Notifications (Email)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # notify-email:
  #   name: ğŸ“§ Email Notification
  #   runs-on: ubuntu-latest
  #   needs: [deploy-staging]
  #   if: failure() && github.ref == 'refs/heads/master'
  #   steps:
  #     - name: Send email notification
  #       if: env.SMTP_PASSWORD != ''
  #       env:
  #         SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
  #         SMTP_PORT: ${{ secrets.SMTP_PORT }}
  #         SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
  #         SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
  #       run: |
  #         if [ -z "$SMTP_PASSWORD" ]; then
  #           echo "SMTP not configured, skipping email notification"
  #           exit 0
  #         fi
          
  #         echo "Sending email notification..."
  #         # Use mailutils or curl to send email
  #         # This is a simplified example - in production, use a proper email action
  #         echo "Pipeline failed for commit ${{ github.sha }}" | \
  #           mail -s "CI/CD Pipeline Failed: ${{ github.repository }}" \
  #           -a "From: github-actions@${{ github.repository_owner }}.com" \
  #           dev-team@example.com || true 
            
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 8: Clean up old artifacts
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
